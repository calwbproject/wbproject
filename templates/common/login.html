{% extends "base.html" %} {% block content %}

<!-- 로그인 폼 (기본 표시) -->
<div id="login_container" style="display: block">
  <h2>로그인</h2>
  <form method="post" id="login_form">
    {% csrf_token %} {{form.non_field_errors}}
    <div>
      <label>ID</label>
      {{ form.username}}
    </div>
    <div>
      <label>Password</label>
      {{form.password}}
    </div>
    <button type="submit">Login</button>
  </form>
  <p>계정이 없으신가요? <a href="#" id="go_to_register">회원가입</a></p>
</div>

<!-- 회원가입 폼 (숨김) -->
<div id="register_container" style="display: none">
  <h2>회원가입</h2>
  <form id="register_form">
    {% csrf_token %}
    <div>
      <label>아이디</label>
      <input type="text" name="username" id="register_username" required />
    </div>
    <div>
      <label>비밀번호</label>
      <input type="password" name="password" id="register_password" required />
    </div>
    <div>
      <label>이름</label>
      <input type="text" name="first_name" id="register_name" required />
    </div>
    <button type="submit">회원가입</button>
    <button type="button" id="cancel_register">취소</button>
  </form>
  <p id="register_error" style="color: red; display: none"></p>
</div>

<script>
  const loginContainer = document.getElementById("login_container");
  const registerContainer = document.getElementById("register_container");
  const goToRegister = document.getElementById("go_to_register");
  const cancelRegister = document.getElementById("cancel_register");
  const registerForm = document.getElementById("register_form");
  const registerError = document.getElementById("register_error");

  // 회원가입으로 이동
  goToRegister.addEventListener("click", (e) => {
    e.preventDefault();
    loginContainer.style.display = "none";
    registerContainer.style.display = "block";
  });

  // 취소하여 로그인으로 돌아감
  cancelRegister.addEventListener("click", () => {
    registerContainer.style.display = "none";
    loginContainer.style.display = "block";
  });

  // 회원가입 폼 비동기 제출
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("register_username").value;
    const password = document.getElementById("register_password").value;
    const first_name = document.getElementById("register_name").value;

    try {
      const res = await fetch("{% url 'common:register' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          username: username,
          password: password,
          first_name: first_name,
        }),
      });

      const data = await res.json();

      if (res.ok) {
        registerError.style.display = "none";
        registerContainer.style.display = "none";
        loginContainer.style.display = "block";
        alert("회원가입이 완료되었습니다. 로그인해주세요.");
      } else {
        registerError.textContent = data.error || "회원가입 실패";
        registerError.style.display = "block";
      }
    } catch (err) {
      console.error(err);
      registerError.textContent = "오류가 발생했습니다.";
      registerError.style.display = "block";
    }
  });
</script>

{% endblock %}
